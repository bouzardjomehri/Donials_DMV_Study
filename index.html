<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Donial's DMV Practice">
    <title>üöó Donial's California DMV Practice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(to bottom, #dbeafe, #bfdbfe);
            min-height: 100vh;
            color: #1f2937;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Header */
        .header {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-bottom: 2px solid #bfdbfe;
            padding: 1rem 0;
        }

        .header h1 {
            text-align: center;
            color: #1e40af;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .header p {
            text-align: center;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        /* Navigation */
        .nav-tabs {
            background: white;
            border-radius: 1rem;
            padding: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin: 1rem 0;
            display: flex;
            gap: 0.5rem;
        }

        .nav-tab {
            flex: 1;
            padding: 1rem;
            border-radius: 0.75rem;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-height: 60px;
        }

        .nav-tab.active-learn {
            background: #3b82f6;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: scale(1.05);
        }

        .nav-tab.active-practice {
            background: #10b981;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: scale(1.05);
        }

        .nav-tab.active-test {
            background: #ef4444;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: scale(1.05);
        }

        .nav-tab:not(.active-learn):not(.active-practice):not(.active-test) {
            background: #f8fafc;
            color: #6b7280;
        }

        .nav-tab:not(.active-learn):not(.active-practice):not(.active-test):hover {
            background: #f1f5f9;
        }

        /* Topic Selector */
        .topic-selector {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 1rem;
            margin-bottom: 1.5rem;
        }

        .topic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        .topic-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .topic-card.active {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .topic-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f9fafb;
        }

        .topic-card:not(.locked):not(.active):hover {
            border-color: #d1d5db;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .topic-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .topic-description {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .topic-progress {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }

        .progress-dot {
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
            background: #d1d5db;
        }

        .progress-dot.completed {
            background: #10b981;
        }

        /* Main Content */
        .main-content {
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
            min-height: 600px;
        }

        .lesson-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .lesson-title {
            font-size: 1.875rem;
            font-weight: bold;
            color: #1e40af;
            margin-bottom: 1rem;
        }

        .sign-display {
            margin: 2rem 0;
            text-align: center;
        }

        .audio-button {
            background: #10b981;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            margin: 1rem auto;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .audio-button:hover {
            background: #059669;
        }

        .audio-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .lesson-section {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 1rem;
            margin: 1.5rem 0;
            border-left: 4px solid;
        }

        .lesson-section.what-is {
            border-left-color: #3b82f6;
            background: #eff6ff;
        }

        .lesson-section.meaning {
            border-left-color: #10b981;
            background: #ecfdf5;
        }

        .lesson-section.action {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .lesson-section.points {
            border-left-color: #8b5cf6;
            background: #f3f4f6;
        }

        .lesson-section h4 {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 0.75rem;
        }

        .lesson-section p,
        .lesson-section li {
            font-size: 1.125rem;
            color: #374151;
            line-height: 1.7;
        }

        .lesson-section ul {
            list-style: none;
            padding: 0;
        }

        .lesson-section li {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
        }

        .lesson-section li::before {
            content: '‚Ä¢';
            color: #8b5cf6;
            font-weight: bold;
            position: absolute;
            left: 0;
            top: 0;
        }

        /* Navigation Buttons */
        .lesson-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .nav-button {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            border: none;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 120px;
        }

        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-button.previous {
            background: #6b7280;
            color: white;
        }

        .nav-button.next {
            background: #3b82f6;
            color: white;
        }

        .nav-button.complete {
            background: #10b981;
            color: white;
        }

        .lesson-progress {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-indicators {
            display: flex;
            gap: 0.5rem;
        }

        .progress-dot-large {
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
            background: #d1d5db;
        }

        .progress-dot-large.current {
            background: #3b82f6;
        }

        .progress-dot-large.completed {
            background: #10b981;
        }

        /* Question Styles */
        .question-container {
            margin: 2rem 0;
        }

        .question-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .option-button {
            width: 100%;
            padding: 1rem 1.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 1rem;
            background: white;
            text-align: left;
            font-size: 1.125rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .option-button:hover {
            border-color: #d1d5db;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .option-button.selected {
            border-color: #3b82f6;
            background: #eff6ff;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .option-letter {
            background: #f3f4f6;
            color: #6b7280;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .feedback {
            padding: 1.5rem;
            border-radius: 1rem;
            margin: 1.5rem 0;
            border: 2px solid;
        }

        .feedback.correct {
            background: #ecfdf5;
            border-color: #10b981;
            color: #065f46;
        }

        .feedback.incorrect {
            background: #fef2f2;
            border-color: #ef4444;
            color: #991b1b;
        }

        .feedback-title {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feedback-explanation {
            font-size: 1.125rem;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .correct-answer {
            background: #ecfdf5;
            padding: 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
        }

        /* Dashboard Styles */
        .dashboard {
            background: linear-gradient(to bottom, #f3e8ff, #e9d5ff);
            min-height: 100vh;
            padding: 2rem 0;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .dashboard-title {
            font-size: 1.875rem;
            font-weight: bold;
            color: #7c3aed;
        }

        .back-button {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }

        .stat-label {
            color: #6b7280;
        }

        /* Progress Overview */
        .progress-overview {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }

        .progress-item {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 0.75rem;
        }

        .progress-bar {
            width: 100%;
            height: 0.5rem;
            background: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: #8b5cf6;
            transition: width 0.3s;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 0 0.5rem;
            }

            .header h1 {
                font-size: 1.25rem;
            }

            .main-content {
                padding: 1rem;
            }

            .lesson-title {
                font-size: 1.5rem;
            }

            .nav-tabs {
                flex-direction: column;
                gap: 0.25rem;
            }

            .nav-tab {
                padding: 0.75rem;
                font-size: 1rem;
            }

            .lesson-nav {
                flex-direction: column-reverse;
                align-items: stretch;
            }

            .nav-button {
                width: 100%;
                margin: 0.25rem 0;
            }

            .topic-grid {
                grid-template-columns: 1fr;
            }

            /* Mobile login styles */
            .login-container {
                padding: 2rem 1.5rem;
                margin: 0 0.5rem;
            }

            .login-header h1 {
                font-size: 1.5rem;
            }

            .logout-btn {
                padding: 0.25rem 0.75rem;
                font-size: 0.75rem;
            }

            .header {
                padding: 0.75rem 0;
            }

            .header > .container > div {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }
        }

        /* Lock icon using CSS */
        .lock-icon::before {
            content: "üîí";
            font-size: 1.5rem;
        }

        .unlock-icon::before {
            content: "üîì";
            font-size: 1.5rem;
        }

        /* Traffic Sign SVGs */
        .traffic-sign {
            width: 8rem;
            height: 8rem;
            margin: 1rem auto;
        }

        /* Hidden class */
        .hidden {
            display: none;
        }

        /* Login Screen Styles */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 0;
            z-index: 1000;
        }

        .login-container {
            background: white;
            border-radius: 2rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 3rem;
            max-width: 500px;
            width: 100%;
            margin: 0 1rem;
            text-align: center;
        }

        .login-header h1 {
            color: #1e40af;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: #6b7280;
            font-size: 1.125rem;
            margin-bottom: 2rem;
        }

        .login-form {
            text-align: left;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
            font-size: 1.125rem;
        }

        .form-group input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            font-size: 1.125rem;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .hint {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.5rem;
            font-style: italic;
        }

        .login-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-size: 1.25rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 2rem;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-help {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 1rem;
            text-align: left;
        }

        .login-help h3 {
            color: #1e40af;
            margin-bottom: 1rem;
            font-size: 1.125rem;
        }

        .login-help ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .login-help li {
            color: #4b5563;
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }

        .logout-btn {
            background: #f3f4f6;
            color: #6b7280;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #e5e7eb;
            color: #374151;
        }

        /* Success/Error messages */
        .message {
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .message.error {
            background: #fef2f2;
            color: #dc2626;
            border: 2px solid #fecaca;
        }

        .message.success {
            background: #ecfdf5;
            color: #047857;
            border: 2px solid #a7f3d0;
        }

        /* Success/Error icons using emojis */
        .success-icon::before {
            content: "‚úÖ";
            font-size: 1.5rem;
        }

        .error-icon::before {
            content: "‚ùå";
            font-size: 1.5rem;
        }

        .play-icon::before {
            content: "‚ñ∂Ô∏è";
        }

        .pause-icon::before {
            content: "‚è∏Ô∏è";
        }

        .volume-icon::before {
            content: "üîä";
        }

        .mute-icon::before {
            content: "üîá";
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Login Screen -->
        <div id="login-screen" class="login-screen">
            <div class="container">
                <div class="login-container">
                    <div class="login-header">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üöó</div>
                        <h1>Welcome to Your DMV Practice</h1>
                        <p>Let's get you ready for the California DMV test!</p>
                    </div>
                    
                    <div class="login-form">
                        <div class="form-group">
                            <label for="student-name">What's your name?</label>
                            <input type="text" id="student-name" placeholder="Enter your name">
                        </div>
                        
                        <div class="form-group">
                            <label for="student-code">Enter your study code:</label>
                            <input type="password" id="student-code" placeholder="Enter code">
                            <div class="hint">Hint: Your favorite yellow video game character</div>
                        </div>
                        
                        <button id="login-button" class="login-btn">
                            Start My DMV Practice
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main App (Hidden until login) -->
        <div id="main-app" class="hidden">
            <!-- Header -->
            <div class="header">
                <div class="container">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h1>üöó Donial's DMV Practice</h1>
                            <p>Official 2023-2025 Handbook Content</p>
                        </div>
                        <button id="logout-button" class="logout-btn">
                            üëã Logout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main App Container -->
            <div class="container">
                <!-- Navigation Tabs -->
                <div class="nav-tabs">
                    <button class="nav-tab active-learn" data-mode="learn">
                        <span>üìö</span> Learn
                    </button>
                    <button class="nav-tab" data-mode="practice">
                        <span>‚úèÔ∏è</span> Practice
                    </button>
                    <button class="nav-tab" data-mode="test">
                        <span>üìù</span> Test
                    </button>
                </div>

                <!-- Topic Selector -->
                <div id="topic-selector" class="topic-selector">
                    <h3>Choose a Topic:</h3>
                    <div class="topic-grid" id="topic-grid">
                        <!-- Topics will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="main-content" id="main-content">
                    <!-- Content will be populated by JavaScript -->
                </div>

                <!-- Progress Overview -->
                <div class="progress-overview">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="font-size: 1.25rem; font-weight: bold; color: #1f2937;">Your Progress</h3>
                        <button id="parent-dashboard-btn" class="back-button" style="background: #8b5cf6; font-size: 0.875rem; padding: 0.5rem 1rem;">
                            <span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span> Parent Dashboard
                        </button>
                    </div>
                    <div class="progress-grid" id="progress-grid">
                        <!-- Progress items will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Parent Dashboard (Hidden by default) -->
            <div id="parent-dashboard" class="dashboard hidden">
                <div class="container">
                    <div class="main-content">
                        <div class="dashboard-header">
                            <h1 class="dashboard-title">Parent Dashboard</h1>
                            <button id="back-to-app" class="back-button">
                                <span>üè†</span> Back to App
                            </button>
                        </div>

                        <div class="stats-grid" id="stats-grid">
                            <!-- Stats will be populated by JavaScript -->
                        </div>

                        <div class="progress-overview">
                            <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: #1f2937;">Topic Progress</h2>
                            <div id="detailed-progress">
                                <!-- Detailed progress will be populated by JavaScript -->
                            </div>
                        </div>

                        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1.5rem; border-radius: 1rem; margin-top: 2rem;">
                            <h2 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem; color: #92400e;">Recommendations</h2>
                            <ul style="color: #b45309; line-height: 1.6;">
                                <li>‚Ä¢ Continue with daily 15-20 minute practice sessions</li>
                                <li>‚Ä¢ Focus on topics with lower scores for additional review</li>
                                <li>‚Ä¢ Practice identifying signs during real car trips</li>
                                <li>‚Ä¢ Consider scheduling DMV test when all topics show 80%+ scores</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End of Main App -->
    </div>

    <script>
        // Application State
        let currentMode = 'learn';
        let currentTopic = 'basic-signs';
        let currentLesson = 0;
        let currentQuestion = 0;
        let userAnswers = [];
        let showResults = false;
        let showParentDashboard = false;
        let audioEnabled = true;
        let isPlaying = false;

        // Login State
        let isLoggedIn = false;
        let currentUser = '';

        // Check for existing login
        const savedLogin = localStorage.getItem('dmv-user-login');
        if (savedLogin) {
            const loginData = JSON.parse(savedLogin);
            isLoggedIn = true;
            currentUser = loginData.name;
        }

        // Progress tracking
        let progress = {
            'basic-signs': { learned: false, practiced: false, tested: false, score: 0, timeSpent: 0 },
            'regulatory-signs': { learned: false, practiced: false, tested: false, score: 0, timeSpent: 0 },
            'warning-signs': { learned: false, practiced: false, tested: false, score: 0, timeSpent: 0 },
            'right-of-way': { learned: false, practiced: false, tested: false, score: 0, timeSpent: 0 },
            'parking-rules': { learned: false, practiced: false, tested: false, score: 0, timeSpent: 0 },
            'speed-limits': { learned: false, practiced: false, tested: false, score: 0, timeSpent: 0 },
            'safe-driving': { learned: false, practiced: false, tested: false, score: 0, timeSpent: 0 }
        };

        // Load progress from localStorage (user-specific)
        function loadUserProgress() {
            if (currentUser) {
                const savedProgress = localStorage.getItem(`dmv-progress-${currentUser.toLowerCase().replace(/\s+/g, '-')}`);
                if (savedProgress) {
                    progress = { ...progress, ...JSON.parse(savedProgress) };
                }
            }
        }

        // Login Functions
        function showMessage(message, type = 'error') {
            const existingMessage = document.querySelector('.message');
            if (existingMessage) {
                existingMessage.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;

            const loginForm = document.querySelector('.login-form');
            loginForm.insertBefore(messageDiv, loginForm.firstChild);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        function handleLogin() {
            const nameInput = document.getElementById('student-name');
            const codeInput = document.getElementById('student-code');
            
            const name = nameInput.value.trim();
            const code = codeInput.value.trim().toLowerCase();

            // Clear any existing messages
            const existingMessage = document.querySelector('.message');
            if (existingMessage) {
                existingMessage.remove();
            }

            // Validation
            if (!name) {
                showMessage('Please enter your name.', 'error');
                nameInput.focus();
                return;
            }

            if (!code) {
                showMessage('Please enter your study code.', 'error');
                codeInput.focus();
                return;
            }

            if (code !== 'pacman') {
                showMessage('Incorrect study code. Hint: Your favorite yellow video game character (all lowercase).', 'error');
                codeInput.focus();
                codeInput.select();
                return;
            }

            // Successful login
            showMessage(`Welcome, ${name}! Loading your DMV practice...`, 'success');
            
            // Save login info
            isLoggedIn = true;
            currentUser = name;
            
            const loginData = {
                name: name,
                loginTime: Date.now()
            };
            
            localStorage.setItem('dmv-user-login', JSON.stringify(loginData));
            
            // Load user's progress
            loadUserProgress();
            
            // Show main app immediately after successful login
            setTimeout(() => {
                showMainApp();
            }, 800);
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout? Your progress is saved.')) {
                isLoggedIn = false;
                currentUser = '';
                localStorage.removeItem('dmv-user-login');
                showLoginScreen();
            }
        }

        function showLoginScreen() {
            // Show login screen and hide main app
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('main-app').classList.add('hidden');
            
            // Clear form
            document.getElementById('student-name').value = '';
            document.getElementById('student-code').value = '';
            
            // Remove any messages
            const existingMessage = document.querySelector('.message');
            if (existingMessage) {
                existingMessage.remove();
            }
        }

        function showMainApp() {
            // Hide login screen and show main app
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('main-app').classList.remove('hidden');
            
            // Initialize topics unlocked status based on progress
            Object.keys(topics).forEach((key, index) => {
                if (index === 0) {
                    topics[key].unlocked = true;
                } else {
                    const prevKey = Object.keys(topics)[index - 1];
                    topics[key].unlocked = progress[prevKey]?.learned || false;
                }
            });
            
            // Initialize app
            updateNavTabs();
            renderCurrentMode();
            updateProgressDisplay();
        }

        // Traffic Sign Components (SVG strings)
        const TrafficSigns = {
            STOP: `<svg viewBox="0 0 200 200" class="traffic-sign">
                <polygon points="50,30 150,30 170,50 170,150 150,170 50,170 30,150 30,50" fill="#FF0000" stroke="#FFFFFF" stroke-width="4"/>
                <text x="100" y="110" text-anchor="middle" fill="#FFFFFF" font-size="24" font-weight="bold" font-family="Arial">STOP</text>
            </svg>`,
            YIELD: `<svg viewBox="0 0 200 200" class="traffic-sign">
                <polygon points="100,20 170,160 30,160" fill="#FFFFFF" stroke="#FF0000" stroke-width="6"/>
                <polygon points="100,40 150,140 50,140" fill="#FF0000"/>
                <text x="100" y="115" text-anchor="middle" fill="#FFFFFF" font-size="16" font-weight="bold" font-family="Arial">YIELD</text>
            </svg>`,
            SPEED_LIMIT: `<svg viewBox="0 0 200 200" class="traffic-sign">
                <rect x="30" y="30" width="140" height="140" fill="#FFFFFF" stroke="#000000" stroke-width="4"/>
                <text x="100" y="70" text-anchor="middle" fill="#000000" font-size="14" font-weight="bold" font-family="Arial">SPEED</text>
                <text x="100" y="90" text-anchor="middle" fill="#000000" font-size="14" font-weight="bold" font-family="Arial">LIMIT</text>
                <text x="100" y="140" text-anchor="middle" fill="#000000" font-size="36" font-weight="bold" font-family="Arial">25</text>
            </svg>`,
            NO_PARKING: `<svg viewBox="0 0 200 200" class="traffic-sign">
                <rect x="30" y="30" width="140" height="140" fill="#FFFFFF" stroke="#000000" stroke-width="4"/>
                <text x="100" y="70" text-anchor="middle" fill="#000000" font-size="14" font-weight="bold" font-family="Arial">NO</text>
                <text x="100" y="100" text-anchor="middle" fill="#000000" font-size="14" font-weight="bold" font-family="Arial">PARKING</text>
                <text x="100" y="130" text-anchor="middle" fill="#000000" font-size="14" font-weight="bold" font-family="Arial">ANY TIME</text>
            </svg>`,
            SCHOOL_ZONE: `<svg viewBox="0 0 200 200" class="traffic-sign">
                <polygon points="100,20 180,100 100,180 20,100" fill="#FFFF00" stroke="#000000" stroke-width="4"/>
                <text x="100" y="95" text-anchor="middle" fill="#000000" font-size="16" font-weight="bold" font-family="Arial">SCHOOL</text>
                <text x="100" y="115" text-anchor="middle" fill="#000000" font-size="16" font-weight="bold" font-family="Arial">ZONE</text>
            </svg>`,
            FOUR_WAY_STOP: `<svg viewBox="0 0 200 200" class="traffic-sign">
                <rect x="90" y="20" width="20" height="160" fill="#666"/>
                <rect x="20" y="90" width="160" height="20" fill="#666"/>
                <polygon points="40,40 60,40 60,20 70,20 70,40 80,40 80,50 70,50 70,70 60,70 60,50 40,50" fill="#FF0000"/>
                <polygon points="120,40 140,40 140,20 150,20 150,40 160,40 160,50 150,50 150,70 140,70 140,50 120,50" fill="#FF0000"/>
                <polygon points="40,120 60,120 60,130 70,130 70,150 60,150 60,170 40,170 40,160 50,160 50,140 40,140" fill="#FF0000"/>
                <polygon points="120,120 140,120 140,130 150,130 150,150 140,150 140,170 120,170 120,160 130,160 130,140 120,140" fill="#FF0000"/>
            </svg>`
        };

        // Topics and Content
        const topics = {
            'basic-signs': {
                title: 'Basic Traffic Signs',
                description: 'Essential signs every California driver must know',
                unlocked: true,
                lessons: [
                    {
                        title: 'STOP Sign',
                        content: 'A red sign with 8 sides. It has white letters that spell "STOP"',
                        meaning: 'You must stop your car completely',
                        action: 'Stop your car. Count to 3 slowly. Then go when it is safe',
                        sign: TrafficSigns.STOP,
                        keyPoints: [
                            'Stop behind the white line on the road',
                            'If there is no white line, stop before the walking area',
                            'If there is no walking area, stop before the road crossing',
                            'Look left, then right, then left again before you go'
                        ],
                        examples: [
                            'When all 4 roads have STOP signs',
                            'When you turn from a small road onto a big road',
                            'Near schools when kids are walking',
                            'Before train tracks in some places'
                        ],
                        audioScript: 'The STOP sign is red with 8 sides and white letters. You must stop your car completely and count to three before you go when it is safe.'
                    },
                    {
                        title: 'YIELD Sign',
                        content: 'A triangle sign that points down. It is red and white and says "YIELD"',
                        meaning: 'Slow down and let other cars go first',
                        action: 'Slow down your car. Look for other cars. Wait until it is safe to go',
                        sign: TrafficSigns.YIELD,
                        keyPoints: [
                            'You can keep going if no cars are coming',
                            'You must stop if cars are coming toward you',
                            'Other cars get to go before you do',
                            'Be ready to stop your car if you need to'
                        ],
                        examples: [
                            'When you drive onto a highway',
                            'At round roads (circles) where cars go around',
                            'When your road joins with another road',
                            'At some places where you get on the highway'
                        ],
                        audioScript: 'The YIELD sign is a red and white triangle that points down. Slow down and let other cars go first.'
                    },
                    {
                        title: 'Speed Limit Sign',
                        content: 'A white square sign with black numbers. It shows how fast you can drive',
                        meaning: 'This is the fastest you can drive when the weather is good',
                        action: 'Look at your speedometer. Drive slower if the weather is bad',
                        sign: TrafficSigns.SPEED_LIMIT,
                        keyPoints: [
                            'This is the fastest speed when everything is good',
                            'Drive slower when it rains or when there is fog',
                            'Drive slower near schools when kids are around',
                            'Drive slower in work zones with orange cones'
                        ],
                        examples: [
                            '25 mph on neighborhood streets',
                            '35 mph on city streets with stores',
                            '55 mph on country roads',
                            '65-80 mph on big highways'
                        ],
                        audioScript: 'Speed limit signs show how fast you can drive. Always drive slower when the weather is bad.'
                    }
                ],
                quiz: [
                    {
                        question: 'What shape is a STOP sign?',
                        options: ['Circle', 'Triangle', 'Sign with 8 sides', 'Rectangle'],
                        correct: 2,
                        explanation: 'STOP signs always have 8 sides (called an octagon). This special shape helps you know it is a STOP sign even if snow covers some of it.',
                        handbook_reference: 'California Driver Handbook, Chapter 5: Traffic Signs'
                    },
                    {
                        question: 'When you see a YIELD sign, you must:',
                        options: ['Always stop your car completely', 'Speed up to go fast', 'Slow down and let other cars go first', 'Treat it like a stop sign'],
                        correct: 2,
                        explanation: 'YIELD means to let other cars go before you. You slow down and wait, but you don\'t have to stop if no cars are coming.'
                    },
                    {
                        question: 'A speed limit sign shows:',
                        options: ['How slow you must go', 'The fastest you can go when weather is good', 'How fast you should always go', 'A suggestion for speed'],
                        correct: 1,
                        explanation: 'Speed limit signs show the fastest you can legally go when the weather is good. You must drive slower when it rains or is foggy.'
                    },
                    {
                        question: 'At a STOP sign, you must stop:',
                        options: ['Only if other cars are coming', 'Behind the white line or before the crosswalk', 'In the middle of the road', 'Only during the day'],
                        correct: 1,
                        explanation: 'You must stop behind the white line if there is one, or before the crosswalk, or before the road crossing if there is no line.'
                    }
                ]
            },
            'regulatory-signs': {
                title: 'Regulatory Signs',
                description: 'Signs that tell you what you must or must not do',
                unlocked: false,
                lessons: [
                    {
                        title: 'No Parking Signs',
                        content: 'White square signs that tell you where you cannot park your car',
                        meaning: 'You cannot leave your car in this place at certain times',
                        action: 'Find a different place to park your car',
                        sign: TrafficSigns.NO_PARKING,
                        keyPoints: [
                            'Red curb means never park there',
                            'Read all signs to know when you cannot park',
                            'If you park wrong, you might get a ticket or your car towed',
                            'Fire trucks and ambulances need these spots clear'
                        ],
                        examples: [
                            'No Parking 7AM-9AM, 4PM-6PM Monday-Friday',
                            'No Parking Anytime (red curb)',
                            'No Parking - Your car will be towed',
                            'No Parking - Fire trucks need this space'
                        ],
                        audioScript: 'No parking signs tell you where and when you cannot park. Always read the whole sign to know the rules.'
                    }
                ],
                quiz: [
                    {
                        question: 'A "No Parking 8AM-6PM Mon-Fri" sign means:',
                        options: ['You can never park there', 'You can park there on weekends', 'You can only park there at night', 'The sign doesn\'t apply to anyone'],
                        correct: 1,
                        explanation: 'This sign says no parking only during those times (8AM-6PM) and days (Monday-Friday). You can park there on weekends and at night.'
                    }
                ]
            },
            'warning-signs': {
                title: 'Warning Signs',
                description: 'Yellow signs that warn of hazards or changes ahead',
                unlocked: false,
                lessons: [
                    {
                        title: 'School Zone Warning',
                        content: 'A yellow diamond sign that tells you there is a school nearby',
                        meaning: 'Children might be walking or playing here - be very careful',
                        action: 'Drive slower and watch for children',
                        sign: TrafficSigns.SCHOOL_ZONE,
                        keyPoints: [
                            'Drive 15-25 mph near schools',
                            'This matters most when school is open',
                            'Look for people helping kids cross the street',
                            'Kids might run into the street without looking'
                        ],
                        examples: [
                            'Near elementary schools (young kids)',
                            'Where kids cross the street to get to school',
                            'Near school bus stops',
                            'Near playgrounds and parks'
                        ],
                        audioScript: 'School zone signs warn that children might be around. Slow down and watch very carefully for children.'
                    }
                ],
                quiz: [
                    {
                        question: 'Yellow warning signs are shaped like:',
                        options: ['Circles', 'Rectangles', 'Diamonds', 'Triangles'],
                        correct: 2,
                        explanation: 'Most warning signs are shaped like diamonds and are yellow to get your attention about dangers ahead.'
                    }
                ]
            },
            'right-of-way': {
                title: 'Right-of-Way Rules',
                description: 'Learn who goes first in different traffic situations',
                unlocked: false,
                lessons: [
                    {
                        title: 'Four-Way Stop Intersection',
                        content: 'A place where 4 roads meet and all roads have STOP signs',
                        meaning: 'The first car to stop gets to go first',
                        action: 'Stop your car, count to 3, then go if you stopped first',
                        sign: TrafficSigns.FOUR_WAY_STOP,
                        keyPoints: [
                            'The car that stops first gets to go first',
                            'If 2 cars stop at the same time, the car on the right goes first',
                            'If you turn left, let cars going straight go first',
                            'People walking always get to go first'
                        ],
                        examples: [
                            'Street corners in neighborhoods',
                            'Entrances to shopping centers',
                            'Street corners near schools',
                            'Where country roads cross each other'
                        ],
                        audioScript: 'At four-way stops, the first car to stop completely goes first. If cars stop together, the car on the right goes first.'
                    }
                ],
                quiz: [
                    {
                        question: 'At a four-way stop, if you and another car arrive at exactly the same time, who goes first?',
                        options: ['The bigger car', 'The car on the right', 'The car going straight', 'Both cars go together'],
                        correct: 1,
                        explanation: 'When two cars arrive at exactly the same time at a four-way stop, the car on the right gets to go first.'
                    }
                ]
            },
            'parking-rules': {
                title: 'Parking Rules',
                description: 'California parking laws and colored curb meanings',
                unlocked: false,
                lessons: [
                    {
                        title: 'Colored Curbs',
                        content: 'Different colored curbs mean different parking rules',
                        meaning: 'Each color tells you if and when you can park there',
                        action: 'Always look at the curb color before you park',
                        sign: `<svg viewBox="0 0 300 120" class="traffic-sign" style="width: 15rem; height: 6rem;">
                            <rect x="10" y="90" width="40" height="20" fill="#FF0000"/>
                            <rect x="60" y="90" width="40" height="20" fill="#FFFF00"/>
                            <rect x="110" y="90" width="40" height="20" fill="#FFFFFF" stroke="#000" stroke-width="1"/>
                            <rect x="160" y="90" width="40" height="20" fill="#00FF00"/>
                            <rect x="210" y="90" width="40" height="20" fill="#0000FF"/>
                            <text x="30" y="80" text-anchor="middle" font-size="10" fill="#000">RED</text>
                            <text x="80" y="80" text-anchor="middle" font-size="10" fill="#000">YELLOW</text>
                            <text x="130" y="80" text-anchor="middle" font-size="10" fill="#000">WHITE</text>
                            <text x="180" y="80" text-anchor="middle" font-size="10" fill="#000">GREEN</text>
                            <text x="230" y="80" text-anchor="middle" font-size="10" fill="#000">BLUE</text>
                        </svg>`,
                        keyPoints: [
                            'Red: Never park here',
                            'Yellow: Only big trucks can stop here to load things',
                            'White: Only to pick up or drop off people (3 minutes)',
                            'Green: Short parking only (15-30 minutes)',
                            'Blue: Only for cars with disabled parking signs'
                        ],
                        examples: [
                            'Red curbs near fire hydrants',
                            'Yellow curbs at stores for delivery trucks',
                            'White curbs at airports',
                            'Green curbs in business areas',
                            'Blue curbs with disabled parking signs'
                        ],
                        audioScript: 'Colored curbs have different parking rules. Red means no parking, yellow is for trucks, white for passengers, green for short parking, and blue for disabled parking only.'
                    }
                ],
                quiz: [
                    {
                        question: 'You cannot park within how many feet of a fire hydrant?',
                        options: ['10 feet', '15 feet', '20 feet', '25 feet'],
                        correct: 1,
                        explanation: 'California law says you must park at least 15 feet away from fire hydrants so fire trucks can get water.'
                    }
                ]
            },
            'speed-limits': {
                title: 'Speed Limits & Safe Driving',
                description: 'California speed limits and when to adjust your speed',
                unlocked: false,
                lessons: [
                    {
                        title: 'California Speed Law',
                        content: 'Drive at a speed that is safe',
                        meaning: 'You must drive slowly when the road, weather, or traffic is bad',
                        action: 'Always change your speed when it is not safe to drive fast',
                        sign: `<svg viewBox="0 0 200 200" class="traffic-sign">
                            <circle cx="100" cy="100" r="80" fill="#FFFF00" stroke="#000" stroke-width="4"/>
                            <circle cx="100" cy="100" r="60" fill="#FFFFFF"/>
                            <text x="100" y="80" text-anchor="middle" font-size="12" font-weight="bold">DRIVE</text>
                            <text x="100" y="100" text-anchor="middle" font-size="12" font-weight="bold">SAFE</text>
                            <text x="100" y="120" text-anchor="middle" font-size="12" font-weight="bold">SPEED</text>
                        </svg>`,
                        keyPoints: [
                            'Speed limit signs are for good weather only',
                            'Drive slower when it rains, snows, or is foggy',
                            'Drive slower when there are lots of cars',
                            'Drive slower when it is dark outside',
                            'School areas and work areas have special slow speeds'
                        ],
                        examples: [
                            'When it rains: Drive 5-10 mph slower',
                            'When there is fog: Use low lights and drive slow',
                            'When there are many cars: Go the same speed as other cars',
                            'Near work zones: Follow the orange signs',
                            'Near schools: Drive 15-25 mph when kids are around'
                        ],
                        audioScript: 'California law says you must drive at a safe speed. Even if the speed limit says 65, drive slower when it rains or when there are problems.'
                    }
                ],
                quiz: [
                    {
                        question: 'California\'s speed law means you must:',
                        options: ['Always drive at the speed limit', 'Drive faster in good weather', 'Drive at a safe speed for conditions', 'Keep up with traffic no matter what'],
                        correct: 2,
                        explanation: 'The speed law requires you to drive at a speed that is safe for current road, weather, and traffic conditions, even if it\'s slower than the speed limit sign.'
                    }
                ]
            },
            'safe-driving': {
                title: 'Safe Driving Practices',
                description: 'Essential safety techniques for California drivers',
                unlocked: false,
                lessons: [
                    {
                        title: 'Following Distance',
                        content: 'The 3-second rule - how far behind other cars you should drive',
                        meaning: 'Keep enough space so you can stop if the car in front stops fast',
                        action: 'Count "one, two, three" slowly between you and the car in front',
                        sign: `<svg viewBox="0 0 300 100" class="traffic-sign" style="width: 15rem; height: 5rem;">
                            <rect x="20" y="70" width="260" height="20" fill="#666"/>
                            <rect x="30" y="60" width="30" height="10" fill="#FF0000"/>
                            <rect x="150" y="60" width="30" height="10" fill="#0066CC"/>
                            <text x="45" y="55" text-anchor="middle" font-size="8" fill="#000">Other Car</text>
                            <text x="165" y="55" text-anchor="middle" font-size="8" fill="#000">Your Car</text>
                            <text x="105" y="45" text-anchor="middle" font-size="12" fill="#000">3 Seconds</text>
                            <line x1="60" y1="65" x2="150" y2="65" stroke="#00FF00" stroke-width="2" stroke-dasharray="5,5"/>
                        </svg>`,
                        keyPoints: [
                            'Find something on the side of the road like a sign or tree',
                            'When the car in front passes it, start counting',
                            'You should pass the same thing after counting to 3',
                            'Count to 4 or 5 when the weather is bad',
                            'Stay farther behind big trucks'
                        ],
                        examples: [
                            'Good weather: Count to 3',
                            'Rain or fog: Count to 4 or 5',
                            'Behind big trucks: Count to 4 or more',
                            'At night: Count to 3 or 4',
                            'On fast roads: Count to 3 or 4'
                        ],
                        audioScript: 'Use the 3-second rule to stay far enough behind other cars. Pick something ahead, and when the car in front passes it, count to three before you pass the same thing.'
                    }
                ],
                quiz: [
                    {
                        question: 'The 3-second rule is used to:',
                        options: ['Know when to change lanes', 'Stay far enough behind other cars', 'Time traffic lights', 'Know speed limits'],
                        correct: 1,
                        explanation: 'The 3-second rule helps you stay far enough behind other cars so you have time to stop if they stop suddenly.'
                    }
                ]
            }
        };

        // Audio functions
        function playAudio(text) {
            if (audioEnabled && 'speechSynthesis' in window) {
                speechSynthesis.cancel(); // Stop any currently playing audio
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.7;
                utterance.volume = 0.9;
                utterance.pitch = 1.0;
                
                speechSynthesis.speak(utterance);
                isPlaying = true;
                
                utterance.onend = () => {
                    isPlaying = false;
                    updateAudioButton();
                };
                
                updateAudioButton();
            }
        }

        function updateAudioButton() {
            const audioButtons = document.querySelectorAll('.audio-button');
            audioButtons.forEach(button => {
                const icon = button.querySelector('span');
                if (icon) {
                    icon.className = isPlaying ? 'pause-icon' : 'play-icon';
                }
                button.disabled = isPlaying;
            });
        }

        // Progress management
        function saveProgress() {
            if (currentUser) {
                const userKey = `dmv-progress-${currentUser.toLowerCase().replace(/\s+/g, '-')}`;
                localStorage.setItem(userKey, JSON.stringify(progress));
            }
        }

        function completeLesson(topicId) {
            progress[topicId].learned = true;
            
            // Unlock next topic
            const topicKeys = Object.keys(topics);
            const currentIndex = topicKeys.indexOf(topicId);
            if (currentIndex < topicKeys.length - 1) {
                const nextTopicKey = topicKeys[currentIndex + 1];
                topics[nextTopicKey].unlocked = true;
            }
            
            saveProgress();
            updateProgressDisplay();
        }

        function completePractice(topicId, score) {
            progress[topicId].practiced = true;
            progress[topicId].score = Math.max(progress[topicId].score, score);
            saveProgress();
            updateProgressDisplay();
        }

        function updateProgressDisplay() {
            // Update main progress display
            const progressGrid = document.getElementById('progress-grid');
            if (progressGrid) {
                progressGrid.innerHTML = '';
                
                Object.entries(topics).forEach(([key, topic]) => {
                    const topicProgress = progress[key];
                    const isLocked = !topic.unlocked && key !== 'basic-signs';
                    
                    const progressItem = document.createElement('div');
                    progressItem.className = 'progress-item';
                    progressItem.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="font-size: 0.875rem; font-weight: 600; color: ${isLocked ? '#9ca3af' : '#1f2937'};">${topic.title}</span>
                            ${isLocked ? '<span class="lock-icon"></span>' : ''}
                        </div>
                        <div style="display: flex; gap: 0.25rem; margin-bottom: 0.5rem;">
                            <div class="progress-dot ${!isLocked && topicProgress.learned ? 'completed' : ''}" title="Learned"></div>
                            <div class="progress-dot ${!isLocked && topicProgress.practiced ? 'completed' : ''}" title="Practiced"></div>
                            <div class="progress-dot ${!isLocked && topicProgress.tested ? 'completed' : ''}" title="Tested"></div>
                        </div>
                        ${!isLocked && topicProgress.score > 0 ? `<div style="font-size: 0.75rem; color: #6b7280;">${topicProgress.score}% score</div>` : ''}
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${isLocked ? 0 : (topicProgress.learned ? 33 : 0) + (topicProgress.practiced ? 33 : 0) + (topicProgress.tested ? 34 : 0)}%"></div>
                        </div>
                    `;
                    progressGrid.appendChild(progressItem);
                });
            }
        }

        // UI Rendering Functions
        function renderTopicSelector() {
            const topicGrid = document.getElementById('topic-grid');
            topicGrid.innerHTML = '';
            
            Object.entries(topics).forEach(([key, topic]) => {
                const topicProgress = progress[key];
                const isLocked = !topic.unlocked && key !== 'basic-signs';
                
                const topicCard = document.createElement('div');
                topicCard.className = `topic-card ${currentTopic === key ? 'active' : ''} ${isLocked ? 'locked' : ''}`;
                
                if (!isLocked) {
                    topicCard.addEventListener('click', () => {
                        currentTopic = key;
                        currentLesson = 0;
                        renderCurrentMode();
                        renderTopicSelector();
                    });
                }
                
                topicCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div class="topic-title">${topic.title}</div>
                            <div class="topic-description">${topic.description}</div>
                            <div class="topic-progress">
                                ${!isLocked && topicProgress.learned ? '<span class="success-icon"></span>' : ''}
                                ${!isLocked && topicProgress.practiced ? `<span style="margin-left: 0.5rem; font-size: 0.75rem; color: #10b981;">‚úì Practiced (${topicProgress.score}%)</span>` : ''}
                            </div>
                        </div>
                        ${isLocked ? '<span class="lock-icon"></span>' : ''}
                    </div>
                `;
                
                topicGrid.appendChild(topicCard);
            });
        }

        function renderLearnMode() {
            const topic = topics[currentTopic];
            const lesson = topic.lessons[currentLesson];
            
            if (!topic.unlocked && currentTopic !== 'basic-signs') {
                document.getElementById('main-content').innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üîí</div>
                        <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: #6b7280;">Topic Locked</h2>
                        <p style="font-size: 1.125rem; color: #6b7280; margin-bottom: 1.5rem;">
                            Complete previous topics first to unlock "${topic.title}".
                        </p>
                        <button class="nav-button next" onclick="currentTopic = 'basic-signs'; renderCurrentMode(); renderTopicSelector();">
                            Go to Available Topic
                        </button>
                    </div>
                `;
                return;
            }
            
            document.getElementById('main-content').innerHTML = `
                <div class="lesson-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 class="lesson-title">${topic.title}</h2>
                        <button onclick="audioEnabled = !audioEnabled; updateAudioButton();" 
                                style="background: #eff6ff; color: #3b82f6; border: none; padding: 0.75rem; border-radius: 9999px; cursor: pointer;">
                            <span class="${audioEnabled ? 'volume-icon' : 'mute-icon'}"></span>
                        </button>
                    </div>
                    
                    <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; border-radius: 0.5rem;">
                        <p style="font-size: 1.125rem; color: #92400e;">${topic.description}</p>
                    </div>
                </div>

                <div class="sign-display">
                    ${lesson.sign}
                    <h3 style="font-size: 1.5rem; font-weight: bold; margin: 1rem 0; color: #1f2937;">${lesson.title}</h3>
                    <button class="audio-button" onclick="playAudio('${lesson.audioScript}')">
                        <span class="play-icon"></span>
                        Listen to Explanation
                    </button>
                </div>

                <div class="lesson-section what-is">
                    <h4 style="color: #1e40af;">What is it?</h4>
                    <p>${lesson.content}</p>
                </div>

                <div class="lesson-section meaning">
                    <h4 style="color: #047857;">What does it mean?</h4>
                    <p>${lesson.meaning}</p>
                </div>

                <div class="lesson-section action">
                    <h4 style="color: #d97706;">What should you do?</h4>
                    <p>${lesson.action}</p>
                </div>

                <div class="lesson-section points">
                    <h4 style="color: #7c3aed;">Key Points:</h4>
                    <ul>
                        ${lesson.keyPoints.map(point => `<li>${point}</li>`).join('')}
                    </ul>
                </div>

                <div class="lesson-section" style="border-left-color: #6366f1; background: #eef2ff;">
                    <h4 style="color: #4338ca;">Real-world Examples:</h4>
                    <ul>
                        ${lesson.examples.map(example => `<li>${example}</li>`).join('')}
                    </ul>
                </div>

                <div class="lesson-nav">
                    <button class="nav-button previous" ${currentLesson === 0 ? 'disabled' : ''} 
                            onclick="if(currentLesson > 0) { currentLesson--; renderLearnMode(); }">
                        Previous
                    </button>

                    <div class="lesson-progress">
                        <span style="font-size: 1.125rem; color: #6b7280;">
                            ${currentLesson + 1} of ${topic.lessons.length}
                        </span>
                        <div class="progress-indicators">
                            ${topic.lessons.map((_, idx) => `
                                <div class="progress-dot-large ${idx === currentLesson ? 'current' : idx < currentLesson ? 'completed' : ''}"></div>
                            `).join('')}
                        </div>
                    </div>

                    ${currentLesson < topic.lessons.length - 1 
                        ? `<button class="nav-button next" onclick="currentLesson++; renderLearnMode();">Next</button>`
                        : `<button class="nav-button complete" onclick="completeLesson('${currentTopic}'); alert('Great job! You completed this lesson. Now you can practice with quiz questions.');">Complete Lesson</button>`
                    }
                </div>
            `;
        }

        function renderPracticeMode() {
            const topic = topics[currentTopic];
            
            if (!progress[currentTopic]?.learned) {
                document.getElementById('main-content').innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üîí</div>
                        <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: #6b7280;">Practice Locked</h2>
                        <p style="font-size: 1.125rem; color: #6b7280; margin-bottom: 1.5rem;">
                            You need to complete the "${topic.title}" lesson first before you can practice.
                        </p>
                        <button class="nav-button next" onclick="currentMode = 'learn'; renderCurrentMode(); updateNavTabs();">
                            Go to Learn Mode
                        </button>
                    </div>
                `;
                return;
            }
            
            // Practice mode implementation
            let currentPracticeQuestion = 0;
            let selectedAnswer = null;
            let showExplanation = false;
            let correctCount = 0;
            let attempts = 0;
            
            function renderPracticeQuestion() {
                const question = topic.quiz[currentPracticeQuestion];
                
                document.getElementById('main-content').innerHTML = `
                    <div style="margin-bottom: 1.5rem;">
                        <h2 style="font-size: 1.5rem; font-weight: bold; color: #047857; margin-bottom: 0.5rem;">Practice: ${topic.title}</h2>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 1.125rem; color: #6b7280; margin-bottom: 1rem;">
                            <span>Question ${currentPracticeQuestion + 1} of ${topic.quiz.length}</span>
                            <span>Score: ${correctCount}/${attempts || 1}</span>
                        </div>
                        <div style="width: 100%; background: #e5e7eb; border-radius: 9999px; height: 0.5rem;">
                            <div style="background: #10b981; height: 0.5rem; border-radius: 9999px; width: ${((currentPracticeQuestion + 1) / topic.quiz.length) * 100}%; transition: width 0.3s;"></div>
                        </div>
                    </div>

                    <div class="question-container">
                        <h3 class="question-text">${question.question}</h3>
                        <div class="options-container" id="options-container">
                            ${question.options.map((option, idx) => `
                                <button class="option-button" data-option="${idx}">
                                    <span class="option-letter">${String.fromCharCode(65 + idx)}</span>
                                    <span>${option}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <div id="feedback-area"></div>
                    <div id="action-buttons"></div>
                `;
                
                // Add click handlers for options
                document.querySelectorAll('.option-button').forEach(button => {
                    button.addEventListener('click', function() {
                        selectedAnswer = parseInt(this.dataset.option);
                        
                        // Remove previous selections
                        document.querySelectorAll('.option-button').forEach(btn => btn.classList.remove('selected'));
                        
                        // Mark current selection
                        this.classList.add('selected');
                        
                        // Show check answer button
                        document.getElementById('action-buttons').innerHTML = `
                            <button class="nav-button complete" onclick="checkAnswer()">Check Answer</button>
                        `;
                    });
                });
                
                // Make checkAnswer available globally for this practice session
                window.checkAnswer = function() {
                    attempts++;
                    const isCorrect = selectedAnswer === question.correct;
                    if (isCorrect) correctCount++;
                    
                    const feedbackArea = document.getElementById('feedback-area');
                    feedbackArea.innerHTML = `
                        <div class="feedback ${isCorrect ? 'correct' : 'incorrect'}">
                            <div class="feedback-title">
                                <span class="${isCorrect ? 'success-icon' : 'error-icon'}"></span>
                                ${isCorrect ? 'Correct! Well done!' : 'Not quite right'}
                            </div>
                            <div class="feedback-explanation">${question.explanation}</div>
                            ${!isCorrect ? `
                                <div class="correct-answer">
                                    The correct answer is: ${String.fromCharCode(65 + question.correct)}. ${question.options[question.correct]}
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    const actionButtons = document.getElementById('action-buttons');
                    let buttonsHTML = '';
                    
                    if (!isCorrect) {
                        buttonsHTML += `<button class="nav-button" style="background: #f59e0b;" onclick="retryQuestion()">Try Again</button>`;
                    }
                    
                    if (currentPracticeQuestion < topic.quiz.length - 1) {
                        buttonsHTML += `<button class="nav-button next" onclick="nextPracticeQuestion()">Next Question</button>`;
                    } else {
                        buttonsHTML += `<button class="nav-button complete" onclick="completePracticeMode()">Complete Practice</button>`;
                    }
                    
                    actionButtons.innerHTML = buttonsHTML;
                };
                
                window.retryQuestion = function() {
                    selectedAnswer = null;
                    document.getElementById('feedback-area').innerHTML = '';
                    document.getElementById('action-buttons').innerHTML = '';
                    document.querySelectorAll('.option-button').forEach(btn => btn.classList.remove('selected'));
                };
                
                window.nextPracticeQuestion = function() {
                    currentPracticeQuestion++;
                    renderPracticeQuestion();
                };
                
                window.completePracticeMode = function() {
                    const finalScore = Math.round((correctCount / attempts) * 100);
                    completePractice(currentTopic, finalScore);
                    alert(`Practice completed! Your score: ${finalScore}%. ${finalScore >= 80 ? 'You can now take the test for this topic!' : 'Review the lesson and try again to improve your score.'}`);
                };
            }
            
            renderPracticeQuestion();
        }

        function renderTestMode() {
            // Create randomized test questions from all topics
            const allQuestions = Object.values(topics).flatMap(topic => topic.quiz);
            const testQuestions = allQuestions
                .sort(() => Math.random() - 0.5)
                .slice(0, Math.min(20, allQuestions.length));
            
            if (!showResults) {
                renderTestQuestion(testQuestions);
            } else {
                renderTestResults(testQuestions);
            }
        }

        function renderTestQuestion(testQuestions) {
            const question = testQuestions[currentQuestion];
            
            document.getElementById('main-content').innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <h2 style="font-size: 1.5rem; font-weight: bold; color: #dc2626; margin-bottom: 0.5rem;">California DMV Practice Test</h2>
                    <p style="color: #6b7280; margin-bottom: 1rem;">Answer all questions to get your results. You need 80% to pass.</p>
                    <div style="display: flex; align-items: center; gap: 1rem; font-size: 1.125rem; color: #6b7280;">
                        <span>Question ${currentQuestion + 1} of ${testQuestions.length}</span>
                        <div style="flex: 1; background: #e5e7eb; border-radius: 9999px; height: 0.75rem;">
                            <div style="background: #dc2626; height: 0.75rem; border-radius: 9999px; width: ${((currentQuestion + 1) / testQuestions.length) * 100}%; transition: width 0.3s;"></div>
                        </div>
                        <span>${Math.round(((currentQuestion + 1) / testQuestions.length) * 100)}%</span>
                    </div>
                </div>

                <div class="question-container">
                    <h3 class="question-text">${question.question}</h3>
                    <div class="options-container" id="test-options">
                        ${question.options.map((option, idx) => `
                            <button class="option-button ${userAnswers[currentQuestion] === idx ? 'selected' : ''}" data-option="${idx}">
                                <span class="option-letter">${String.fromCharCode(65 + idx)}</span>
                                <span>${option}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; margin-top: 2rem;">
                    <button class="nav-button previous" ${currentQuestion === 0 ? 'disabled' : ''} 
                            onclick="if(currentQuestion > 0) { currentQuestion--; renderTestMode(); }">
                        Previous
                    </button>
                    
                    ${currentQuestion < testQuestions.length - 1 
                        ? `<button class="nav-button" style="background: #dc2626;" ${userAnswers[currentQuestion] === undefined ? 'disabled' : ''} onclick="currentQuestion++; renderTestMode();">Next</button>`
                        : `<button class="nav-button complete" ${userAnswers.length < testQuestions.length || userAnswers.includes(undefined) ? 'disabled' : ''} onclick="showResults = true; renderTestMode();">Finish Test</button>`
                    }
                </div>

                <div style="margin-top: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 1rem;">
                    <h4 style="font-size: 0.875rem; font-weight: 600; color: #6b7280; margin-bottom: 0.75rem;">Question Progress:</h4>
                    <div style="display: grid; grid-template-columns: repeat(10, 1fr); gap: 0.5rem;">
                        ${testQuestions.map((_, idx) => `
                            <button onclick="currentQuestion = ${idx}; renderTestMode();"
                                    style="width: 2rem; height: 2rem; border-radius: 50%; border: none; font-size: 0.875rem; font-weight: 600; cursor: pointer;
                                           background: ${idx === currentQuestion ? '#dc2626' : userAnswers[idx] !== undefined ? '#10b981' : '#e5e7eb'};
                                           color: ${idx === currentQuestion || userAnswers[idx] !== undefined ? 'white' : '#6b7280'};">
                                ${idx + 1}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Add click handlers for test options
            document.querySelectorAll('#test-options .option-button').forEach(button => {
                button.addEventListener('click', function() {
                    const optionIndex = parseInt(this.dataset.option);
                    
                    // Update userAnswers array
                    userAnswers[currentQuestion] = optionIndex;
                    
                    // Update visual selection
                    document.querySelectorAll('#test-options .option-button').forEach(btn => btn.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    // Enable next/finish button
                    const nextButton = document.querySelector('.nav-button:not(.previous)');
                    if (nextButton) {
                        nextButton.disabled = false;
                    }
                });
            });
        }

        function renderTestResults(testQuestions) {
            const score = userAnswers.reduce((correct, answer, idx) => {
                return correct + (answer === testQuestions[idx].correct ? 1 : 0);
            }, 0);
            const percentage = Math.round((score / testQuestions.length) * 100);
            const passed = percentage >= 80;
            
            document.getElementById('main-content').innerHTML = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div style="font-size: 5rem; margin-bottom: 1rem;">${passed ? 'üéâ' : 'üìö'}</div>
                    <h2 style="font-size: 2.5rem; font-weight: bold; margin-bottom: 1rem; color: ${passed ? '#047857' : '#dc2626'};">
                        ${passed ? 'Congratulations! You Passed!' : 'Keep Studying!'}
                    </h2>
                    <p style="font-size: 1.875rem; margin-bottom: 1.5rem; color: #1f2937; font-weight: bold;">
                        ${score} out of ${testQuestions.length} correct (${percentage}%)
                    </p>
                    
                    <div style="padding: 1.5rem; border-radius: 1rem; margin-bottom: 2rem; ${passed ? 'background: #ecfdf5; color: #047857;' : 'background: #fef2f2; color: #dc2626;'}">
                        <p style="font-size: 1.25rem;">
                            ${passed 
                                ? `Great job! You scored ${percentage}% and are ready for the real California DMV written test. Remember to study the official handbook and practice safe driving!`
                                : `You need 80% or higher to pass. Review the topics where you missed questions and try again. Focus on the areas that need improvement below.`
                            }
                        </p>
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h3 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: #1f2937;">Question Review</h3>
                    <div style="max-height: 400px; overflow-y: auto; space-y: 1rem;">
                        ${testQuestions.map((question, idx) => `
                            <div style="padding: 1rem; border-radius: 0.75rem; border: 2px solid ${userAnswers[idx] === question.correct ? '#10b981' : '#ef4444'}; 
                                        background: ${userAnswers[idx] === question.correct ? '#ecfdf5' : '#fef2f2'}; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                    <h4 style="font-weight: 600; color: #1f2937;">Q${idx + 1}: ${question.question}</h4>
                                    <span style="font-size: 1.25rem;">${userAnswers[idx] === question.correct ? '‚úÖ' : '‚ùå'}</span>
                                </div>
                                <div style="font-size: 0.875rem; color: #6b7280;">
                                    <p>Your answer: <span style="color: ${userAnswers[idx] === question.correct ? '#10b981' : '#ef4444'};">
                                        ${question.options[userAnswers[idx]]}
                                    </span></p>
                                    ${userAnswers[idx] !== question.correct ? `
                                        <p>Correct answer: <span style="color: #10b981;">${question.options[question.correct]}</span></p>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <button class="nav-button" style="background: #3b82f6;" onclick="resetTest()">Retake Test</button>
                    <button class="nav-button" style="background: #10b981;" onclick="currentMode = 'learn'; renderCurrentMode(); updateNavTabs();">Review Lessons</button>
                    <button class="nav-button" style="background: #f59e0b;" onclick="currentMode = 'practice'; renderCurrentMode(); updateNavTabs();">More Practice</button>
                </div>
            `;
        }

        function resetTest() {
            showResults = false;
            currentQuestion = 0;
            userAnswers = [];
            renderTestMode();
        }

        // Parent Dashboard
        function renderParentDashboard() {
            const totalTopics = Object.keys(topics).length;
            const completedTopics = Object.values(progress).filter(p => p.learned && p.practiced).length;
            const totalTimeSpent = Object.values(progress).reduce((total, p) => total + p.timeSpent, 0);
            const averageScore = Object.values(progress).filter(p => p.score > 0).reduce((sum, p, _, arr) => sum + p.score / arr.length, 0) || 0;
            
            document.getElementById('parent-dashboard').classList.remove('hidden');
            document.querySelector('#main-app .container').style.display = 'none';
            
            // Update dashboard title
            document.querySelector('.dashboard-title').textContent = 'Progress Dashboard';
            
            // Update stats
            document.getElementById('stats-grid').innerHTML = `
                <div class="stat-card" style="background: #eff6ff;">
                    <div style="font-size: 2rem; color: #3b82f6;">üìä</div>
                    <div class="stat-value" style="color: #1e40af;">${completedTopics}/${totalTopics}</div>
                    <div class="stat-label">Topics Completed</div>
                </div>
                <div class="stat-card" style="background: #ecfdf5;">
                    <div style="font-size: 2rem; color: #10b981;">üèÜ</div>
                    <div class="stat-value" style="color: #047857;">${Math.round(averageScore)}%</div>
                    <div class="stat-label">Average Score</div>
                </div>
                <div class="stat-card" style="background: #fef3c7;">
                    <div style="font-size: 2rem; color: #f59e0b;">‚è∞</div>
                    <div class="stat-value" style="color: #d97706;">${Math.round(totalTimeSpent / 60000)}m</div>
                    <div class="stat-label">Time Spent</div>
                </div>
                <div class="stat-card" style="background: #f3e8ff;">
                    <div style="font-size: 2rem; color: #8b5cf6;">‚úÖ</div>
                    <div class="stat-value" style="color: #7c3aed;">${Math.round((completedTopics/totalTopics)*100)}%</div>
                    <div class="stat-label">Overall Progress</div>
                </div>
            `;
            
            // Update detailed progress
            document.getElementById('detailed-progress').innerHTML = Object.entries(topics).map(([key, topic]) => {
                const topicProgress = progress[key];
                const progressPercent = (topicProgress.learned ? 33 : 0) + (topicProgress.practiced ? 33 : 0) + (topicProgress.tested ? 34 : 0);
                
                return `
                    <div class="progress-item">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <h3 style="font-weight: 600; color: #1f2937;">${topic.title}</h3>
                            <div style="display: flex; gap: 0.25rem;">
                                ${topicProgress.learned ? '<span style="color: #3b82f6; font-size: 1rem;">‚úÖ</span>' : ''}
                                ${topicProgress.practiced ? '<span style="color: #10b981; font-size: 1rem;">‚úÖ</span>' : ''}
                                ${topicProgress.tested ? '<span style="color: #8b5cf6; font-size: 1rem;">‚úÖ</span>' : ''}
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">
                            <span>Score: ${topicProgress.score}%</span>
                            <span>Time: ${Math.round(topicProgress.timeSpent / 60000)}m</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function hideParentDashboard() {
            document.getElementById('parent-dashboard').classList.add('hidden');
            document.querySelector('#main-app .container').style.display = 'block';
        }

        // Mode rendering
        function renderCurrentMode() {
            const topicSelectorDiv = document.getElementById('topic-selector');
            
            if (currentMode === 'learn' || currentMode === 'practice') {
                topicSelectorDiv.style.display = 'block';
                renderTopicSelector();
            } else {
                topicSelectorDiv.style.display = 'none';
            }
            
            switch (currentMode) {
                case 'learn':
                    renderLearnMode();
                    break;
                case 'practice':
                    renderPracticeMode();
                    break;
                case 'test':
                    renderTestMode();
                    break;
            }
        }

        function updateNavTabs() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active-learn', 'active-practice', 'active-test');
                if (tab.dataset.mode === currentMode) {
                    tab.classList.add(`active-${currentMode}`);
                }
            });
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in
            if (isLoggedIn) {
                loadUserProgress();
                showMainApp();
            } else {
                showLoginScreen();
            }
            
            // Login form handlers
            document.getElementById('login-button').addEventListener('click', handleLogin);
            
            // Allow Enter key to submit login
            document.getElementById('student-name').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });
            
            document.getElementById('student-code').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });
            
            // Logout handler
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            
            // Navigation tab clicks
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    currentMode = this.dataset.mode;
                    currentQuestion = 0;
                    userAnswers = [];
                    showResults = false;
                    updateNavTabs();
                    renderCurrentMode();
                });
            });
            
            // Parent dashboard buttons
            document.getElementById('parent-dashboard-btn').addEventListener('click', renderParentDashboard);
            document.getElementById('back-to-app').addEventListener('click', hideParentDashboard);
        });
    </script>
</body>
</html>